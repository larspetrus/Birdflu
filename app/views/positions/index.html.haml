.leftmenu= link_to 'Random Position', "positions/#{Position.random_id}"
= render 'find_by_alg'

%hr{style: 'clear:both;'}

.left_side_stats
  %span#rubric
    #{@aggregate_stats.position_count} positions
  %table
    %tr
      %td Shortest
      %td.optimal= @aggregate_stats.shortest
    %tr
      %td Fastest
      %td.optimal= '%.2f' % @aggregate_stats.fastest
    %tr
      %td Avg shortest
      %td= @shortest_average
    %tr.spacer
    - @aggregate_stats.raw_counts.keys.sort.each do |length|
      %tr
        %td #{length} moves
        %td= pluralize(@aggregate_stats.raw_counts[length], 'alg')

%div{style: 'position: absolute; top:4px; right:4px; font-size: 8px; color: #888;'}
  Cache #{number_to_human_size Rails.cache.instance_variable_get('@cache_size')}

%table.center
  %tr
    %th COP
    %th EO
    %th EP
    %th OLL
  %tr#pickers
    = render 'picker_td', prop: :cop, add_class: 'with-lines'
    = render 'picker_td', prop: :eo
    = render 'picker_td', prop: :ep,  add_class: 'relative', ubl_text: true
    = render 'picker_td', prop: :oll, add_class: 'with-lines'


=form_tag url_for(controller: "positions", action: "index"), method: 'post', id: 'icon-picker' do
  =hidden_field_tag(:cop, @filters[:cop])
  =hidden_field_tag(:eo,  @filters[:eo])
  =hidden_field_tag(:ep,  @filters[:ep])
  =hidden_field_tag(:oll, @filters[:oll])

.center.page-format-header
  =form_tag url_for(controller: "positions", action: "index"), method: 'post', id: 'page_format_form' do
    Show as
    =select_tag("page_format", options_for_select(['positions', 'algs'], selected: @page_format))

- if @page_format == 'algs'

  .center.alg-list-header{style: "border-top: 1px solid #aaa; padding-top: 8px;"}
    =form_tag url_for(controller: "positions", action: "index"), method: 'get', id: 'algs_options' do
      Show first
      =select_tag("page", options_for_select([25, 50, 100, 200, 500], selected: @page))

      =hidden_field_tag(:algtypes, @algtypes)
      only single algs

      .right
        Sort by
        =select_tag("sortby", options_for_select(['speed', ['moves', 'length']], selected: @sortby))


  %table.index.alg-list
    %thead
      =first_2_headers(@sortby)
      %th Name
      %th Position
      %th Alg
      %th
      %th Notes
    - @raw_algs.each do |alg|
      %tr
        =first_2_columns(@sortby, alg, shortest: alg.length == @aggregate_stats.shortest, fastest: alg.speed == @aggregate_stats.fastest)
        %td{class: alg.css_kind}= alg_name_td(alg)
        %td= link_to alg.position.display_name, "/positions/#{alg.position.ll_code}"
        %td= alg.moves
        %td{:'data-us' => alg.setup_moves}
          %a{class: "show-pig"} show
        %td
          = alg.specialness
- else
  %table.index.pos-list
    %th Position
    %th COP
    %th EO
    %th EP
    %th OLL
    %th Solutions
    %th{colspan: 3} Shortest Solution

    - @positions.each do |pos|
      - cache([pos.ll_code, pos.alg_count], skip_digest: true) do
        - best = pos.best_alg || OpenStruct.new
        %tr
          %td= link_to pos.display_name, "/positions/#{pos.ll_code}"
          %td= render 'svg_cube', icon: Icons::Cop.for(pos), size: 25, label: ''
          %td= render 'svg_cube', icon: Icons::Eo.for(pos),  size: 25, label: ''
          %td= render 'svg_cube', icon: Icons::Ep.for(pos),  size: 25, label: ''
          %td= render 'svg_cube', icon: Icons::Oll.for(pos), size: 25, label: ''
          %td= pos.alg_count
          %td= best.length
          %td= best.moves
          %td{:'data-us' => best.setup_moves}
            %a{class: "show-pig"} show

#show-alg{style: 'height:200px; width:200px;'}
%script ROOFPIG_CONF_AD = "solved=U-| hover=3 | speed=600"

:javascript
  // --------- Icon dependencies (quite primitive) ----
  $('.svg-icon, .random, .unselect').on('click', function() {
    var field = $(this).data('field');
    if (field === '#cop') { $('#eo, #ep').val(''); }
    if (field === '#oll') { $('#cop, #eo, #ep').val(''); }
    $(field).val($(this).data('code'));
    $('form#icon-picker').submit();
  });

  // --------- Open/Close picker dialogs ---
  var mouse_is_inside_picker = '';

  var picker_dialog_props = {
    cop: opts({ width: '400px', title: 'Corner orientation & position (COP)'}),
    eo:  opts({ width: '394px', title: 'Edge orientation (EO)'}),
    ep:  opts({ width: '572px', title: 'Edge position (EP)'}),
    oll: opts({ width: '404px', title: 'Corner and edge orientation (OLL)'}),
  };
  function opts(specifics) {
    var pos = { my: 'center top', at: 'center bottom', of: '#pickers' };
    return $.extend(specifics, {resizable: false, modal: false, draggable: false, position: pos, dialogClass: "picker-dialog"});
  };

  $('#cop-selected, #eo-selected, #ep-selected, #oll-selected').hover(
    function(event){
      var field = event.currentTarget.id.split('-')[0];
      var picker = $('#'+field+'-picker').dialog(picker_dialog_props[field]);
      picker.parent().attr('data-field', field)
    },
    function(event){
      var field = event.currentTarget.id.split('-')[0];
      setTimeout(function(){
        if (mouse_is_inside_picker != field) { $('#'+field+'-picker').dialog('close'); }
      }, 100);
    }
  );

  $(document).on({
    mouseenter: function(event) {
      mouse_is_inside_picker = $(event.currentTarget).attr('data-field')
    },
    mouseleave: function(event) {
      var field = $(event.currentTarget).attr('data-field')
      $('#'+field+'-picker').dialog('close');
      mouse_is_inside_picker = ''
    }
  }, ".picker-dialog");

  // --------- Show Roofpigs ---
  $(document).on('click', '.alg-list .show-pig', function(e) {
    var td = $(event.target).parent()
    var alg = td.prev().text()
    var title = td.prev().prev().prev().text()

    roofpig_dialog(title, alg, td.data("us"))
  });

  $(document).on('click', '.pos-list .show-pig', function(e) {
    var td = $(event.target).parent();
    var alg = td.prev().text();
    var title = td.siblings().first().text() + ' shortest';

    roofpig_dialog(title, alg, td.data("us"))
  });

  // ---- page format form
  $('#page_format').change(function() {
    $('form#page_format_form').submit();
  });

  // ---- alg list form
  $('#page, #sortby, #algtypes').change(function() {
    $('form#algs_options').submit();
  });

